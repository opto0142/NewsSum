<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewsSum Dashboard</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
<header>
    <h1>NewsSum</h1>
    <p>AI powered news summarization dashboard</p>
</header>
<main>
    <section>
        <h2>ğŸ” ë¡œê·¸ì¸</h2>
        <form id="loginForm">
            <label for="email">ì´ë©”ì¼</label>
            <input id="email" type="email" placeholder="user@example.com" required>
            <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
            <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (8ì ì´ìƒ)" required>
            <button type="submit">ë¡œê·¸ì¸</button>
            <p id="loginError" class="error"></p>
            <p id="loginSuccess"></p>
        </form>
        <p style="margin-top: 16px; font-size: 14px;">
            ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <a href="#signup" onclick="toggleSignup(event)">íšŒì›ê°€ì…</a>
        </p>
    </section>

    <section id="signupSection" style="display: none;">
        <h2>ğŸ“ íšŒì›ê°€ì…</h2>
        <form id="signupForm">
            <label for="signupEmail">ì´ë©”ì¼</label>
            <input id="signupEmail" type="email" placeholder="user@example.com" required>
            <label for="signupPassword">ë¹„ë°€ë²ˆí˜¸ (8ì ì´ìƒ, ìˆ«ì í¬í•¨)</label>
            <input id="signupPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
            <label for="signupNickname">ë‹‰ë„¤ì„</label>
            <input id="signupNickname" type="text" placeholder="ë‹‰ë„¤ì„" required>
            <button type="submit">íšŒì›ê°€ì…</button>
            <p id="signupError" class="error"></p>
            <p id="signupSuccess"></p>
        </form>
    </section>

    <section id="afterLogin" style="display: none;">
        <h2>ğŸ“° ë‰´ìŠ¤ ìš”ì•½ ëŒ€ì‹œë³´ë“œ</h2>
        <p>í”„ë¦¬ë¯¸ì—˜ ê¸°ëŠ¥ì— ì ‘ê·¼í•˜ë ¤ë©´ í”„ë¡œëª¨ì…˜ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
        <div>
            <label for="promoCode">í”„ë¡œëª¨ì…˜ ì½”ë“œ</label>
            <input id="promoCode" type="text" placeholder="í”„ë¡œëª¨ì…˜ ì½”ë“œ">
            <button onclick="applyPromo()">ì ìš©</button>
            <p id="promoError" class="error"></p>
            <p id="promoSuccess"></p>
        </div>
        <hr>
        <p><a href="/news.html">â¡ï¸ ë‰´ìŠ¤ í¬ë¡¤ëŸ¬ ë° íˆìŠ¤í† ë¦¬ ë³´ê¸°</a></p>
        <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </section>
</main>

<script>
    function toggleSignup(e) {
        e.preventDefault();
        document.getElementById('signupSection').style.display = 
            document.getElementById('signupSection').style.display === 'none' ? 'block' : 'none';
    }

    function saveToken(token) {
        localStorage.setItem('accessToken', token);
        showAfterLogin();
    }

    function getToken() {
        return localStorage.getItem('accessToken');
    }

    function showAfterLogin() {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('signupSection').style.display = 'none';
        document.getElementById('afterLogin').style.display = 'block';
    }

    function showBeforeLogin() {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('signupSection').style.display = 'none';
        document.getElementById('afterLogin').style.display = 'none';
    }

    function logout() {
        localStorage.removeItem('accessToken');
        document.getElementById('loginError').textContent = '';
        document.getElementById('loginSuccess').textContent = '';
        document.getElementById('signupError').textContent = '';
        document.getElementById('signupSuccess').textContent = '';
        document.getElementById('promoError').textContent = '';
        document.getElementById('promoSuccess').textContent = '';
        showBeforeLogin();
    }

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        try {
            const res = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            
            if (!res.ok) {
                document.getElementById('loginError').textContent = data.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
                return;
            }
            
            document.getElementById('loginSuccess').textContent = 'ë¡œê·¸ì¸ ì„±ê³µ! âœ…';
            saveToken(data.data.accessToken);
        } catch (err) {
            document.getElementById('loginError').textContent = 'ì˜¤ë¥˜: ' + err.message;
        }
    });

    document.getElementById('signupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        const nickname = document.getElementById('signupNickname').value;
        
        try {
            const res = await fetch('/api/auth/signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password, nickname })
            });
            const data = await res.json();
            
            if (!res.ok) {
                document.getElementById('signupError').textContent = data.message || 'íšŒì›ê°€ì… ì‹¤íŒ¨';
                return;
            }
            
            document.getElementById('signupSuccess').textContent = 'íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”. âœ…';
            document.getElementById('signupForm').reset();
            setTimeout(() => {
                document.getElementById('signupSection').style.display = 'none';
                document.getElementById('email').focus();
            }, 2000);
        } catch (err) {
            document.getElementById('signupError').textContent = 'ì˜¤ë¥˜: ' + err.message;
        }
    });

    async function applyPromo() {
        const token = getToken();
        const promoCode = document.getElementById('promoCode').value;
        
        if (!promoCode) {
            document.getElementById('promoError').textContent = 'í”„ë¡œëª¨ì…˜ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
            return;
        }
        
        try {
            const res = await fetch('/api/promo/apply', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ promoCode })
            });
            const data = await res.json();
            
            if (!res.ok) {
                document.getElementById('promoError').textContent = data.message || 'í”„ë¡œëª¨ì…˜ ì½”ë“œ ì ìš© ì‹¤íŒ¨';
                return;
            }
            
            document.getElementById('promoSuccess').textContent = 'í”„ë¡œëª¨ì…˜ ì½”ë“œ ì ìš© ì„±ê³µ! ğŸ‰';
            document.getElementById('promoCode').value = '';
        } catch (err) {
            document.getElementById('promoError').textContent = 'ì˜¤ë¥˜: ' + err.message;
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í† í° í™•ì¸
    if (getToken()) {
        showAfterLogin();
    } else {
        showBeforeLogin();
    }
</script>
</body>
</html>
